<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack Fresh ‚Äî Intake System</title>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #22263a;
            --border: #2d3148;
            --text: #e8eaf0;
            --text-dim: #8b90a5;
            --accent: #4f7df9;
            --accent-hover: #3b6ae8;
            --green: #2dd4a0;
            --green-bg: rgba(45, 212, 160, 0.12);
            --amber: #f5a623;
            --amber-bg: rgba(245, 166, 35, 0.12);
            --red: #f05252;
            --red-bg: rgba(240, 82, 82, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text); line-height: 1.55;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            margin-bottom: 24px;
        }
        header .container { display: flex; align-items: center; gap: 16px; }
        .logo { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }
        header .status { margin-left: auto; font-size: 0.85rem; color: var(--text-dim); }
        .status-dot {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-right: 6px;
        }
        .status-dot.ok { background: var(--green); }
        .status-dot.warn { background: var(--amber); }

        /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 24px;
            border-bottom: 1px solid var(--border); padding-bottom: 0;
        }
        .tab {
            padding: 10px 20px; background: none; border: none;
            border-bottom: 2px solid transparent; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; color: var(--text-dim);
            transition: all 0.15s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 24px; margin-bottom: 20px;
        }
        .card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; }

        /* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.85rem; font-weight: 500; color: var(--text-dim); }
        input, select, textarea {
            padding: 10px 12px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text); font-size: 0.95rem;
            transition: border-color 0.15s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--accent);
        }
        input[type="file"] { padding: 8px; }
        input[type="file"]::file-selector-button {
            background: var(--accent); color: #fff; border: none;
            padding: 6px 14px; border-radius: 4px; cursor: pointer;
            margin-right: 10px; font-size: 0.85rem;
        }

        /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
            transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }
        .btn-success { background: var(--green); color: #000; }
        .btn-danger { background: var(--red); color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 0.82rem; }

        /* ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .stat {
            background: var(--surface-2); border-radius: 8px; padding: 16px;
            border: 1px solid var(--border);
        }
        .stat-label { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 4px; }
        .stat-value { font-size: 1.6rem; font-weight: 700; }

        /* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 10px;
            font-size: 0.78rem; font-weight: 600;
        }
        .badge-green { background: var(--green-bg); color: var(--green); }
        .badge-amber { background: var(--amber-bg); color: var(--amber); }
        .badge-blue { background: rgba(79,125,249,0.12); color: var(--accent); }
        .badge-red { background: var(--red-bg); color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ‚îÄ */
        .alert {
            padding: 12px 16px; border-radius: 8px; margin-bottom: 16px;
            font-size: 0.9rem; border: 1px solid;
        }
        .alert-success { background: var(--green-bg); border-color: var(--green); color: var(--green); }
        .alert-warning { background: var(--amber-bg); border-color: var(--amber); color: var(--amber); }
        .alert-error { background: var(--red-bg); border-color: var(--red); color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ */
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
        th { font-weight: 600; color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .row-unmapped { background: var(--amber-bg); }

        /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 1000;
            align-items: flex-start; justify-content: center;
            backdrop-filter: blur(4px);
            padding: 40px 20px;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        /* Mapping modal must stack ABOVE session modal */
        #mapping-modal { z-index: 1100; }
        /* Themed prompt/confirm modal stacks above everything */
        #themed-prompt-overlay { z-index: 1200; align-items: center; }
        .modal {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 28px; width: 90%; max-width: 640px;
            max-height: 85vh; overflow-y: auto; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 1.2rem; }
        .modal-close {
            background: none; border: none; color: var(--text-dim);
            font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;
        }
        /* Sticky close button that follows scroll */
        .modal-close-sticky {
            position: sticky; top: 0; float: right;
            background: var(--surface-2); border: 1px solid var(--border);
            color: var(--text); font-size: 1.3rem; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; margin-top: -8px; margin-right: -8px;
            transition: all 0.15s;
        }
        .modal-close-sticky:hover { background: var(--red); color: #fff; border-color: var(--red); }

        /* Action dropdown ‚Äî fixed position to avoid overflow issues */
        .action-dropdown {
            display: none; position: fixed;
            z-index: 1050; background: var(--surface-2); border: 1px solid var(--border);
            border-radius: 6px; padding: 4px; width: 160px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }
        .action-dropdown.show { display: block !important; }
        .action-dropdown button {
            display: block; width: 100%; text-align: left; font-size: 0.8rem;
            background: none; color: var(--text); padding: 8px 10px;
            border: none; border-radius: 4px; cursor: pointer;
            white-space: nowrap;
        }
        .action-dropdown button:hover { background: var(--surface); }
        .action-dropdown hr { border: none; border-top: 1px solid var(--border); margin: 4px 0; }

        /* Themed prompt modal */
        .prompt-modal {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; width: 90%; max-width: 420px;
        }
        .prompt-modal h3 { font-size: 1.1rem; margin-bottom: 12px; }
        .prompt-modal p { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 16px; }
        .prompt-modal input, .prompt-modal textarea {
            width: 100%; margin-bottom: 12px;
        }
        .prompt-modal .prompt-buttons {
            display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;
        }
        .divider { text-align: center; color: var(--text-dim); margin: 16px 0; font-size: 0.85rem; position: relative; }
        .divider::before, .divider::after {
            content: ''; position: absolute; top: 50%; height: 1px;
            background: var(--border); width: 40%;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* ‚îÄ‚îÄ‚îÄ SEARCH RESULTS ‚îÄ‚îÄ‚îÄ */
        .search-result {
            padding: 12px; border: 1px solid var(--border); border-radius: 6px;
            margin-top: 8px; cursor: pointer; transition: all 0.15s;
        }
        .search-result:hover { border-color: var(--accent); background: var(--surface-2); }
        .search-result h4 { font-size: 0.95rem; margin-bottom: 4px; }
        .search-result p { font-size: 0.82rem; color: var(--text-dim); }

        /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 40px; color: var(--text-dim); }
        .spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 2px solid var(--border); border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr 1fr; }
            .stat { padding: 10px; }
            .stat-value { font-size: 1.2rem; }

            /* Modal fills screen on mobile */
            .modal-overlay { padding: 10px; }
            .modal { max-width: 100%; padding: 16px; max-height: 92vh; }
            .prompt-modal { max-width: 100%; padding: 16px; }

            /* Table: make it scrollable but keep action column visible */
            table { font-size: 0.8rem; }
            th, td { padding: 8px 6px; }
            
            /* Stack tab bar and allow scroll */
            .tabs { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
            .tab { white-space: nowrap; padding: 8px 12px; font-size: 0.82rem; }

            /* Bigger touch targets */
            .btn { min-height: 40px; padding: 10px 16px; }
            .btn-sm { min-height: 34px; padding: 8px 12px; }
            .action-dropdown button { padding: 12px 10px; font-size: 0.85rem; }
            .search-result { padding: 14px; }

            /* Session detail: hide less important columns */
            .hide-mobile { display: none; }

            header .container { flex-wrap: wrap; }
            .logo { font-size: 1.2rem; }
        }

        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr; }
            .modal { padding: 12px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Pack <span>Fresh</span></div>
            <div style="color: var(--text-dim); font-size: 0.9rem;">Intake System</div>
            <div class="status">
                <span class="status-dot ok" id="health-dot"></span>
                <span id="health-text">Connected</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('sealed-intake')">Sealed Intake (CSV)</button>
            <button class="tab" onclick="switchTab('raw-intake')">Raw Card Entry</button>
            <button class="tab" onclick="switchTab('active-sessions')">Active Sessions</button>
            <button class="tab" onclick="switchTab('completed')">Completed</button>
            <button class="tab" onclick="switchTab('cancelled')">Cancelled</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEALED INTAKE TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="sealed-intake" class="tab-content active">
            <div class="card">
                <h2>Upload Collectr CSV</h2>
                <form id="csv-upload-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="csv-customer" placeholder="e.g. Raul" required>
                        </div>
                        <div class="form-group">
                            <label>Offer Percentage (%)</label>
                            <input type="number" id="csv-offer-pct" value="75" min="1" max="100" step="0.5" required>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:16px;">
                        <label>Collectr CSV Export</label>
                        <input type="file" id="csv-file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload &amp; Process</button>
                </form>
            </div>
            <div id="csv-upload-result"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RAW CARD ENTRY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="raw-intake" class="tab-content">
            <div class="card">
                <h2>Manual Raw Card Entry</h2>
                <p style="color:var(--text-dim); margin-bottom:16px; font-size:0.9rem;">
                    Create a session, then add cards one at a time. Prices are fetched from PPT by tcgplayer ID + condition.
                </p>

                <!-- Create session section -->
                <div id="raw-session-setup">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="raw-customer" value="Walk-in">
                        </div>
                        <div class="form-group">
                            <label>Offer Percentage (%)</label>
                            <input type="number" id="raw-offer-pct" value="65" min="1" max="100" step="0.5">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="createRawSession()">Start Raw Intake Session</button>
                </div>

                <!-- Active raw session card entry -->
                <div id="raw-entry-form" style="display:none;">
                    <div class="alert alert-success" id="raw-session-info"></div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>TCGPlayer ID *</label>
                            <input type="number" id="raw-tcgplayer-id" placeholder="e.g. 490294">
                        </div>
                        <div class="form-group">
                            <label>Card Name *</label>
                            <input type="text" id="raw-card-name" placeholder="e.g. Charizard ex">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Condition *</label>
                            <select id="raw-condition">
                                <option value="NM">Near Mint (NM)</option>
                                <option value="LP">Lightly Played (LP)</option>
                                <option value="MP">Moderately Played (MP)</option>
                                <option value="HP">Heavily Played (HP)</option>
                                <option value="DMG">Damaged (DMG)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="raw-quantity" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label>Price Override (optional)</label>
                            <input type="text" id="raw-price-override" placeholder="Leave blank for PPT price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Set Name (auto-filled from PPT)</label>
                            <input type="text" id="raw-set-name" placeholder="Auto-filled">
                        </div>
                        <div class="form-group">
                            <label>Card Number</label>
                            <input type="text" id="raw-card-number" placeholder="e.g. 125">
                        </div>
                        <div class="form-group">
                            <label>Rarity</label>
                            <input type="text" id="raw-rarity" placeholder="Auto-filled">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn btn-secondary" onclick="lookupRawCard()">
                            Lookup Price from PPT
                        </button>
                        <button class="btn btn-primary" onclick="addRawCard()">Add Card to Session</button>
                    </div>
                    <div id="raw-lookup-result"></div>

                    <!-- Items added so far -->
                    <div id="raw-items-table"></div>

                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="finalizeRawSession()">Finalize Session</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACTIVE SESSIONS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="active-sessions" class="tab-content">
            <div class="card">
                <h2>Active Intake Sessions</h2>
                <div id="active-sessions-list" class="loading"><span class="spinner"></span> Loading...</div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPLETED TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="completed" class="tab-content">
            <div class="card">
                <h2>Completed Intakes</h2>
                <div id="completed-sessions-list" class="loading"><span class="spinner"></span> Loading...</div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CANCELLED TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="cancelled" class="tab-content">
            <div class="card">
                <h2>Cancelled Sessions</h2>
                <div id="cancelled-sessions-list" class="loading"><span class="spinner"></span> Loading...</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="session-modal" class="modal-overlay">
        <div class="modal" style="max-width:900px;">
            <button class="modal-close-sticky" onclick="closeModal('session-modal')">&times;</button>
            <div id="session-modal-body"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEMED PROMPT/CONFIRM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="themed-prompt-overlay" class="modal-overlay">
        <div class="prompt-modal">
            <h3 id="tp-title"></h3>
            <p id="tp-message"></p>
            <div id="tp-inputs"></div>
            <div class="prompt-buttons">
                <button class="btn btn-secondary" id="tp-cancel">Cancel</button>
                <button class="btn btn-primary" id="tp-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAPPING MODAL (must be AFTER session modal in DOM) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="mapping-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Link Product to TCGPlayer ID</h3>
                <button class="modal-close" onclick="closeModal('mapping-modal')">&times;</button>
            </div>
            <div style="margin-bottom:16px;">
                <strong>Product:</strong> <span id="map-product-name" style="color:var(--accent);"></span><br>
                <strong>Set:</strong> <span id="map-set-name"></span><br>
                <strong>Collectr Price:</strong> <span id="map-collectr-price" style="font-weight:700;"></span>
            </div>

            <div class="form-group" style="margin-bottom:12px;">
                <label>Paste TCGPlayer ID</label>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="map-tcgplayer-id" placeholder="e.g. 624679" style="flex:1;">
                    <button class="btn btn-primary btn-sm" onclick="linkAndCompare()">Link &amp; Compare</button>
                </div>
                <small style="color:var(--text-dim);">Find the ID at tcgplayer.com/product/&lt;ID&gt;/</small>
            </div>

            <!-- Price comparison panel (hidden until Link & Compare is clicked) -->
            <div id="price-comparison" style="display:none;"></div>

            <div class="divider">or try auto-match</div>

            <div class="form-group">
                <button class="btn btn-secondary" onclick="fuzzySearch()" style="width:100%;">
                    Search PPT for Matches
                </button>
            </div>
            <div id="fuzzy-results"></div>
        </div>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEMED PROMPT/CONFIRM SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function themedPrompt({ title, message, inputs = [], confirmText = 'Confirm', confirmClass = 'btn-primary', dangerous = false }) {
        return new Promise((resolve) => {
            const overlay = document.getElementById('themed-prompt-overlay');
            document.getElementById('tp-title').textContent = title;
            document.getElementById('tp-message').textContent = message || '';
            document.getElementById('tp-message').style.display = message ? 'block' : 'none';
            const confirmBtn = document.getElementById('tp-confirm');
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `btn ${dangerous ? 'btn-danger' : confirmClass}`;

            const inputsDiv = document.getElementById('tp-inputs');
            inputsDiv.innerHTML = inputs.map((inp, idx) => {
                if (inp.type === 'number') {
                    return `<div class="form-group"><label>${inp.label}</label>
                        <input type="number" id="tp-input-${idx}" value="${inp.default || ''}" 
                               min="${inp.min || ''}" max="${inp.max || ''}" step="${inp.step || 'any'}"
                               placeholder="${inp.placeholder || ''}"></div>`;
                } else if (inp.type === 'textarea') {
                    return `<div class="form-group"><label>${inp.label}</label>
                        <textarea id="tp-input-${idx}" rows="2" placeholder="${inp.placeholder || ''}">${inp.default || ''}</textarea></div>`;
                } else {
                    return `<div class="form-group"><label>${inp.label}</label>
                        <input type="text" id="tp-input-${idx}" value="${inp.default || ''}" 
                               placeholder="${inp.placeholder || ''}"></div>`;
                }
            }).join('');

            overlay.classList.add('active');
            if (inputs.length > 0) {
                setTimeout(() => document.getElementById('tp-input-0')?.focus(), 50);
            }

            function cleanup() {
                overlay.classList.remove('active');
                document.getElementById('tp-cancel').removeEventListener('click', onCancel);
                document.getElementById('tp-confirm').removeEventListener('click', onConfirm);
            }
            function onCancel() { cleanup(); resolve(null); }
            function onConfirm() {
                const values = inputs.map((_, idx) => document.getElementById(`tp-input-${idx}`)?.value ?? '');
                cleanup();
                resolve(inputs.length === 0 ? true : inputs.length === 1 ? values[0] : values);
            }
            document.getElementById('tp-cancel').addEventListener('click', onCancel);
            document.getElementById('tp-confirm').addEventListener('click', onConfirm);
            // Enter key confirms
            inputsDiv.addEventListener('keydown', (e) => { if (e.key === 'Enter') onConfirm(); });
        });
    }

    function themedConfirm(title, message, { confirmText = 'Confirm', dangerous = false } = {}) {
        return themedPrompt({ title, message, inputs: [], confirmText, dangerous });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ESCAPE KEY & CLICK-OUTSIDE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // Close topmost modal
            const tp = document.getElementById('themed-prompt-overlay');
            if (tp.classList.contains('active')) { tp.classList.remove('active'); return; }
            const mapping = document.getElementById('mapping-modal');
            if (mapping.classList.contains('active')) { closeModal('mapping-modal'); return; }
            const session = document.getElementById('session-modal');
            if (session.classList.contains('active')) { closeModal('session-modal'); return; }
        }
    });
    // Click outside modal to close
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
            }
        });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentSessionId = null;
    let currentMapItemId = null;
    let currentMapProductType = 'sealed';
    let rawSessionId = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(name) {
        document.querySelectorAll('.tab').forEach((t, i) => {
            t.classList.toggle('active', t.textContent.toLowerCase().includes(name.replace(/-/g,' ').split(' ')[0]));
        });
        // simpler: just match by data
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(name).classList.add('active');

        // re-highlight the clicked tab
        event.target.classList.add('active');
        document.querySelectorAll('.tab').forEach(t => { if (t !== event.target) t.classList.remove('active'); });

        if (name === 'active-sessions') loadSessions('in_progress', 'active-sessions-list');
        if (name === 'completed') loadSessions('finalized', 'completed-sessions-list');
        if (name === 'cancelled') loadSessions('cancelled', 'cancelled-sessions-list');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CSV UPLOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('csv-upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const resultDiv = document.getElementById('csv-upload-result');
        resultDiv.innerHTML = '<div class="card"><div class="loading"><span class="spinner"></span> Processing CSV...</div></div>';

        const form = new FormData();
        form.append('file', document.getElementById('csv-file').files[0]);
        form.append('customer_name', document.getElementById('csv-customer').value);
        form.append('offer_percentage', document.getElementById('csv-offer-pct').value);

        try {
            const r = await fetch('/api/intake/upload-collectr', { method: 'POST', body: form });
            const d = await r.json();
            if (!r.ok) {
                resultDiv.innerHTML = `<div class="alert alert-error">${d.error}${d.existing_session_id ? ` (Session: ${d.existing_session_id.slice(0,8)}...)` : ''}</div>`;
                return;
            }

            resultDiv.innerHTML = `
                <div class="alert alert-success">Uploaded! Session ${d.session_id.slice(0,8)}...</div>
                <div class="stats">
                    <div class="stat"><div class="stat-label">Items</div><div class="stat-value">${d.item_count}</div></div>
                    <div class="stat"><div class="stat-label">Market Value</div><div class="stat-value">$${d.total_market_value.toFixed(2)}</div></div>
                    <div class="stat"><div class="stat-label">Your Offer</div><div class="stat-value">$${d.total_offer.toFixed(2)}</div></div>
                    <div class="stat"><div class="stat-label">Auto-Mapped</div><div class="stat-value">${d.auto_mapped_count}/${d.item_count}</div></div>
                </div>
                ${d.unmapped_count > 0 ? `<div class="alert alert-warning">${d.unmapped_count} items need TCGPlayer ID linking</div>` : '<div class="alert alert-success">All items auto-mapped from cache!</div>'}
                <button class="btn btn-primary" onclick="viewSession('${d.session_id}')">View &amp; Map Items</button>
            `;
            document.getElementById('csv-upload-form').reset();
        } catch(err) {
            resultDiv.innerHTML = `<div class="alert alert-error">Upload failed: ${err.message}</div>`;
        }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadSessions(status, containerId) {
        const c = document.getElementById(containerId);
        c.innerHTML = '<div class="loading"><span class="spinner"></span> Loading...</div>';
        try {
            const r = await fetch(`/api/intake/sessions?status=${status}`);
            const d = await r.json();
            if (!d.sessions.length) { c.innerHTML = '<p style="color:var(--text-dim);">No sessions found.</p>'; return; }

            c.innerHTML = `<table>
                <thead><tr>
                    <th>Customer</th><th>Type</th><th>Items</th><th>Offer</th>
                    <th>Unmapped</th><th>Created</th><th></th>
                </tr></thead>
                <tbody>${d.sessions.map(s => `<tr>
                    <td>${s.customer_name || 'Unknown'}</td>
                    <td><span class="badge badge-blue">${s.session_type}</span></td>
                    <td>${s.item_count || 0}</td>
                    <td>$${(s.total_offer_amount || 0).toFixed(2)}</td>
                    <td>${(s.unmapped_count || 0) > 0
                        ? `<span class="badge badge-amber">${s.unmapped_count}</span>`
                        : '<span class="badge badge-green">‚úì</span>'}</td>
                    <td>${new Date(s.created_at).toLocaleDateString()}</td>
                    <td><button class="btn btn-secondary btn-sm" onclick="viewSession('${s.id}')">View</button></td>
                </tr>`).join('')}</tbody>
            </table>`;
        } catch(err) {
            c.innerHTML = `<div class="alert alert-error">Failed to load: ${err.message}</div>`;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEW SESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function viewSession(sessionId) {
        currentSessionId = sessionId;
        const body = document.getElementById('session-modal-body');
        body.innerHTML = '<div class="loading"><span class="spinner"></span></div>';
        openModal('session-modal');

        try {
            const r = await fetch(`/api/intake/session/${sessionId}`);
            const d = await r.json();
            const s = d.session;
            const items = d.items;

            body.innerHTML = `
                <div class="stats">
                    <div class="stat"><div class="stat-label">Customer</div><div class="stat-value" style="font-size:1.1rem;">${s.customer_name}</div></div>
                    <div class="stat"><div class="stat-label">Type</div><div class="stat-value" style="font-size:1.1rem;"><span class="badge badge-blue">${s.session_type}</span></div></div>
                    <div class="stat"><div class="stat-label">Market Value</div><div class="stat-value">$${(s.total_market_value || 0).toFixed(2)}</div></div>
                    <div class="stat">
                        <div class="stat-label">Offer %</div>
                        <div class="stat-value" style="display:flex; align-items:center; gap:8px;">
                            <span id="offer-pct-display">${s.offer_percentage}%</span>
                            ${s.status === 'in_progress' ? `
                                <button class="btn btn-sm btn-secondary" style="font-size:0.75rem; padding:2px 8px;" 
                                        onclick="editOfferPct('${sessionId}', ${s.offer_percentage})">Edit</button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="stat"><div class="stat-label">Offer Total</div><div class="stat-value">$${(s.total_offer_amount || 0).toFixed(2)}</div></div>
                </div>

                ${s.status === 'in_progress' ? `
                    <div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="refreshPrices('${sessionId}')">
                            üîÑ Refresh PPT Prices
                        </button>
                        <button class="btn btn-sm" style="background:var(--red); color:#fff;" 
                                onclick="cancelSession('${sessionId}')">
                            ‚úï Cancel Session
                        </button>
                    </div>
                ` : ''}

                <!-- Price comparison results go here -->
                <div id="price-refresh-results"></div>

                ${(s.unmapped_count || 0) > 0 ? `<div class="alert alert-warning">${s.unmapped_count} items need linking before finalization</div>` : ''}

                <div style="overflow-x:auto;">
                <table>
                    <thead><tr>
                        <th>Product</th><th>Qty</th><th>Market</th><th>Offer</th><th>Status</th><th>Actions</th>
                    </tr></thead>
                    <tbody>${items.map(i => {
                        const status = i.item_status || 'good';
                        const isDead = status === 'missing' || status === 'rejected';
                        const isDamaged = status === 'damaged';
                        const rowStyle = isDead ? 'opacity:0.45; text-decoration:line-through;' 
                                       : isDamaged ? 'background:rgba(255,170,0,0.08);' : '';
                        const statusBadge = status === 'good' 
                            ? (i.is_mapped ? '<span class="badge badge-green">Linked</span>' : '<span class="badge badge-amber">Needs Link</span>')
                            : status === 'damaged' ? '<span class="badge" style="background:#b45309;color:#fff;">Damaged</span>'
                            : status === 'missing' ? '<span class="badge" style="background:#666;color:#fff;">Missing</span>'
                            : '<span class="badge" style="background:#666;color:#fff;">Rejected</span>';
                        const overrideNote = i.price_override_note ? `<br><small style="color:var(--accent);" title="${(i.price_override_note||'').replace(/"/g,'&quot;')}">‚ö° ${i.price_override_note}</small>` : '';
                        const parentNote = i.parent_item_id ? '<br><small style="color:var(--text-dim);">‚Ü≥ split from above</small>' : '';
                        
                        return `<tr style="${rowStyle}">
                            <td>
                                ${i.product_name}
                                ${i.set_name ? `<br><small style="color:var(--text-dim);">${i.set_name}</small>` : ''}
                                ${overrideNote}${parentNote}
                            </td>
                            <td>${i.quantity}</td>
                            <td>$${(i.market_price || 0).toFixed(2)}</td>
                            <td>$${(i.offer_price || 0).toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td style="white-space:nowrap;">
                                ${s.status === 'in_progress' ? (() => {
                                    let btns = '';
                                    if (isDead) {
                                        btns += `<button class="btn btn-sm btn-secondary" style="font-size:0.7rem;padding:2px 6px;" onclick="restoreItem('${i.id}','${sessionId}')">Restore</button>`;
                                    } else {
                                        // Link button for unmapped
                                        if (!i.is_mapped && !isDamaged) {
                                            btns += `<button class="btn btn-primary btn-sm" style="font-size:0.7rem;padding:2px 6px;" data-item-id="${i.id}" data-name="${(i.product_name||'').replace(/"/g,'&quot;')}" data-set="${(i.set_name||'').replace(/"/g,'&quot;')}" data-type="${i.product_type||'sealed'}" data-price="${i.market_price||0}" onclick="openMapping(this.dataset.itemId, this.dataset.name, this.dataset.set, this.dataset.type, parseFloat(this.dataset.price))">Link</button> `;
                                        }
                                        // Action dropdown
                                        btns += `<div style="display:inline-block; position:relative;">
                                            <button class="btn btn-sm btn-secondary action-trigger" style="font-size:0.7rem;padding:2px 6px;" 
                                                    onclick="toggleActionMenu(this)">‚ãÆ</button>
                                            <div class="action-dropdown">
                                                ${!isDamaged ? `<button onclick="damageItem('${i.id}','${sessionId}',${i.quantity})">üî® Damage</button>` : ''}
                                                <button onclick="overridePrice('${i.id}','${sessionId}',${i.market_price})">üí∞ Override Price</button>
                                                <button onclick="editQuantity('${i.id}','${sessionId}',${i.quantity})">‚úè Edit Qty</button>
                                                <button onclick="markMissing('${i.id}','${sessionId}')">‚ùå Missing</button>
                                                <button onclick="markRejected('${i.id}','${sessionId}')">üö´ Rejected</button>
                                                <hr>
                                                <button style="color:var(--red);" onclick="deleteItem('${i.id}','${sessionId}')">üóë Delete</button>
                                            </div>
                                        </div>`;
                                    }
                                    return btns;
                                })() : (i.is_mapped ? `<small style="color:var(--text-dim);">ID: ${i.tcgplayer_id}</small>` : '')}
                            </td>
                        </tr>`;
                    }).join('')}</tbody>
                </table>
                </div>

                ${s.status === 'in_progress' && (s.session_type === 'sealed' || s.session_type === 'mixed') ? `
                    <div style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
                        <h4 style="margin-bottom:12px;">‚ûï Add Sealed Item</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex:2;">
                                <label>Search PPT</label>
                                <input type="text" id="session-sealed-search" placeholder="e.g. Celebrations Elite Trainer Box">
                            </div>
                            <div class="form-group">
                                <label>Qty</label>
                                <input type="number" id="session-sealed-qty" value="1" min="1" style="width:70px;">
                            </div>
                            <div class="form-group" style="justify-content:flex-end;">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="searchSealedForSession('${sessionId}', ${s.offer_percentage})">Search</button>
                            </div>
                        </div>
                        <div id="session-sealed-results" style="margin-top:8px;"></div>
                    </div>
                ` : ''}

                ${s.status === 'in_progress' && s.session_type === 'raw' ? `
                    <div style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
                        <h4 style="margin-bottom:12px;">‚ûï Add Card to This Session</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>TCGPlayer ID</label>
                                <input type="number" id="session-raw-tcg-id" placeholder="e.g. 490294">
                            </div>
                            <div class="form-group">
                                <label>Condition</label>
                                <select id="session-raw-condition">
                                    <option value="NM">Near Mint</option>
                                    <option value="LP">Lightly Played</option>
                                    <option value="MP">Moderately Played</option>
                                    <option value="HP">Heavily Played</option>
                                    <option value="DMG">Damaged</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Variant</label>
                                <input type="text" id="session-raw-variant" placeholder="e.g. Holofoil">
                            </div>
                            <div class="form-group">
                                <label>Qty</label>
                                <input type="number" id="session-raw-qty" value="1" min="1" style="width:70px;">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addCardToExistingSession('${sessionId}', ${s.offer_percentage})">
                            Look Up &amp; Add
                        </button>
                        <div id="session-raw-result" style="margin-top:12px;"></div>
                    </div>
                ` : ''}

                ${s.status === 'cancelled' ? `
                    <div class="alert alert-error" style="margin-top:16px;">
                        Session cancelled${s.cancel_reason ? ': ' + s.cancel_reason : ''}
                    </div>
                ` : ''}

                ${(() => {
                    if (s.status !== 'in_progress') return '';
                    const activeItems = items.filter(i => (i.item_status || 'good') === 'good' || i.item_status === 'damaged');
                    const unmappedActive = activeItems.filter(i => !i.is_mapped && (i.item_status || 'good') === 'good');
                    const excluded = items.filter(i => i.item_status === 'missing' || i.item_status === 'rejected');
                    let html = '';
                    if (excluded.length > 0) {
                        html += `<div style="margin-top:12px;color:var(--text-dim);font-size:0.85rem;">
                            ${excluded.length} item(s) excluded (missing/rejected)
                        </div>`;
                    }
                    if (unmappedActive.length === 0 && activeItems.length > 0) {
                        html += `<div style="margin-top:12px;">
                            <button class="btn btn-success" onclick="finalizeSession('${sessionId}')">
                                Finalize Session (${activeItems.length} items)
                            </button>
                        </div>`;
                    }
                    return html;
                })()}
            `;
        } catch(err) {
            body.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAPPING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentMapCollectrPrice = 0;

    function openMapping(itemId, productName, setName, productType, collectrPrice) {
        currentMapItemId = itemId;
        currentMapProductType = productType || 'sealed';
        currentMapCollectrPrice = collectrPrice || 0;
        document.getElementById('map-product-name').textContent = productName;
        document.getElementById('map-set-name').textContent = setName || 'N/A';
        document.getElementById('map-collectr-price').textContent = `$${currentMapCollectrPrice.toFixed(2)}`;
        document.getElementById('map-tcgplayer-id').value = '';
        document.getElementById('fuzzy-results').innerHTML = '';
        document.getElementById('price-comparison').style.display = 'none';
        document.getElementById('price-comparison').innerHTML = '';
        openModal('mapping-modal');
    }

    async function linkAndCompare() {
        const tcgId = document.getElementById('map-tcgplayer-id').value;
        if (!tcgId) { alert('Enter a TCGPlayer ID'); return; }

        const panel = document.getElementById('price-comparison');
        panel.style.display = 'block';
        panel.innerHTML = '<div class="loading"><span class="spinner"></span> Fetching PPT price...</div>';

        // Step 1: Look up PPT price
        let pptPrice = null;
        let pptProductName = '';
        try {
            const endpoint = currentMapProductType === 'raw' ? '/api/ppt/lookup-card' : '/api/ppt/lookup-sealed';
            const r = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tcgplayer_id: parseInt(tcgId) }),
            });
            const d = await r.json();
            if (r.ok) {
                const item = d.card || d.product || {};
                // Sealed products use 'unopenedPrice', cards use 'prices.market'
                pptPrice = item.unopenedPrice             // sealed products
                        || d.extracted_price               // backend pre-extracted
                        || item.prices?.market             // cards
                        || item.prices?.mid                // fallback
                        || item.market_price               // flat field
                        || null;
                pptProductName = item.name || item.productName || '';
            } else {
                // PPT lookup failed ‚Äî still allow linking, just no price comparison
                panel.innerHTML = `
                    <div class="alert alert-warning" style="margin-top:12px;">
                        PPT lookup failed: ${d.error || 'Unknown error'}. You can still link with the Collectr price.
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:8px;" 
                            onclick="confirmLink(${currentMapCollectrPrice})">
                        Link with Collectr Price ($${currentMapCollectrPrice.toFixed(2)})
                    </button>`;
                return;
            }
        } catch(err) {
            panel.innerHTML = `
                <div class="alert alert-error" style="margin-top:12px;">${err.message}</div>
                <button class="btn btn-primary" style="width:100%; margin-top:8px;" 
                        onclick="confirmLink(${currentMapCollectrPrice})">
                    Link with Collectr Price ($${currentMapCollectrPrice.toFixed(2)})
                </button>`;
            return;
        }

        // Step 2: Show price comparison
        const collectr = currentMapCollectrPrice;
        const ppt = pptPrice || 0;
        const delta = collectr > 0 ? ((ppt - collectr) / collectr * 100) : 0;
        const absDelta = Math.abs(delta);
        const significant = absDelta > 10;
        const deltaColor = significant ? (delta > 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-dim)';
        const deltaIcon = delta > 0 ? '‚ñ≤' : delta < 0 ? '‚ñº' : '‚Äî';

        panel.innerHTML = `
            ${pptProductName ? `<div style="margin-bottom:10px; font-size:0.85rem; color:var(--text-dim);">PPT match: <strong style="color:var(--text);">${pptProductName}</strong></div>` : ''}
            
            <div style="display:grid; grid-template-columns: 1fr auto 1fr; gap:12px; align-items:center; margin:12px 0;">
                <!-- Collectr price -->
                <div style="background:var(--surface-2); border:2px solid var(--border); border-radius:8px; padding:14px; text-align:center; cursor:pointer; transition:all 0.15s;"
                     onclick="selectPrice('collectr')" id="price-option-collectr">
                    <div style="font-size:0.75rem; color:var(--text-dim); font-weight:600; text-transform:uppercase;">Collectr</div>
                    <div style="font-size:1.4rem; font-weight:700; margin:4px 0;">$${collectr.toFixed(2)}</div>
                    <div style="font-size:0.75rem; color:var(--text-dim);">From CSV import</div>
                </div>

                <!-- Delta -->
                <div style="text-align:center;">
                    <div style="font-size:1.1rem; font-weight:700; color:${deltaColor};">
                        ${deltaIcon} ${absDelta.toFixed(1)}%
                    </div>
                    ${significant ? `<div style="font-size:0.7rem; color:${deltaColor}; font-weight:600;">‚ö† SIGNIFICANT</div>` : ''}
                </div>

                <!-- PPT price -->
                <div style="background:var(--surface-2); border:2px solid var(--border); border-radius:8px; padding:14px; text-align:center; cursor:pointer; transition:all 0.15s;"
                     onclick="selectPrice('ppt')" id="price-option-ppt">
                    <div style="font-size:0.75rem; color:var(--text-dim); font-weight:600; text-transform:uppercase;">PPT (Live)</div>
                    <div style="font-size:1.4rem; font-weight:700; margin:4px 0;">${ppt > 0 ? '$' + ppt.toFixed(2) : 'N/A'}</div>
                    <div style="font-size:0.75rem; color:var(--text-dim);">TCGPlayer market</div>
                </div>
            </div>

            <!-- Custom price option -->
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                <span style="font-size:0.85rem; color:var(--text-dim);">Or custom:</span>
                <input type="number" id="custom-price" placeholder="Enter price" step="0.01" style="width:120px;" 
                       onfocus="selectPrice('custom')">
                <button class="btn btn-sm btn-secondary" onclick="selectPrice('custom')" id="price-option-custom-btn" 
                        style="opacity:0.5;">Custom</button>
            </div>

            <!-- Confirm button -->
            <button class="btn btn-primary" style="width:100%;" id="confirm-link-btn" data-ppt-price="${ppt}" onclick="confirmSelectedLink(${ppt})">
                Select a price above, then confirm
            </button>
        `;

        // Default selection: PPT if available and significant diff, otherwise Collectr
        if (ppt > 0 && significant) {
            selectPrice('ppt');
        } else {
            selectPrice('collectr');
        }
    }

    let selectedPriceSource = null;

    function selectPrice(source) {
        selectedPriceSource = source;
        // Update visual selection
        ['collectr', 'ppt'].forEach(s => {
            const el = document.getElementById('price-option-' + s);
            if (el) {
                el.style.borderColor = s === source ? 'var(--accent)' : 'var(--border)';
                el.style.background = s === source ? 'rgba(79,125,249,0.08)' : 'var(--surface-2)';
            }
        });
        const customBtn = document.getElementById('price-option-custom-btn');
        if (customBtn) customBtn.style.opacity = source === 'custom' ? '1' : '0.5';

        // Update confirm button text
        const btn = document.getElementById('confirm-link-btn');
        if (btn) {
            if (source === 'collectr') {
                btn.textContent = `Confirm Link ‚Äî Use Collectr Price ($${currentMapCollectrPrice.toFixed(2)})`;
            } else if (source === 'ppt') {
                const pptVal = btn.dataset.pptPrice || '0';
                btn.textContent = `Confirm Link ‚Äî Use PPT Price ($${parseFloat(pptVal).toFixed(2)})`;
            } else {
                btn.textContent = 'Confirm Link ‚Äî Use Custom Price';
            }
        }
    }

    async function confirmSelectedLink(pptPrice) {
        let finalPrice;
        if (selectedPriceSource === 'collectr') {
            finalPrice = currentMapCollectrPrice;
        } else if (selectedPriceSource === 'ppt') {
            finalPrice = pptPrice;
        } else if (selectedPriceSource === 'custom') {
            finalPrice = parseFloat(document.getElementById('custom-price').value);
            if (isNaN(finalPrice) || finalPrice <= 0) { alert('Enter a valid custom price'); return; }
        } else {
            alert('Select a price first'); return;
        }
        await confirmLink(finalPrice);
    }

    async function confirmLink(price) {
        const tcgId = document.getElementById('map-tcgplayer-id').value;
        try {
            const r = await fetch('/api/intake/map-item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    item_id: currentMapItemId,
                    tcgplayer_id: parseInt(tcgId),
                    verify_price: false,
                    override_price: price,
                }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            closeModal('mapping-modal');
            viewSession(currentSessionId);
        } catch(err) { alert(err.message); }
    }

    async function fuzzySearch() {
        const productName = document.getElementById('map-product-name').textContent;
        const setName = document.getElementById('map-set-name').textContent;
        const container = document.getElementById('fuzzy-results');
        container.innerHTML = '<div class="loading"><span class="spinner"></span> Searching PPT...</div>';

        // Choose endpoint based on product type
        const endpoint = currentMapProductType === 'raw' ? '/api/ppt/search-cards' : '/api/ppt/search-sealed';

        // PPT's `set` param expects set ID slugs (like "sv08-surging-sparks"),
        // not display names (like "SV: 151"), so don't pass it.
        // The product name from Collectr already has enough context.
        const body = { query: productName };

        try {
            const r = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const d = await r.json();
            if (!r.ok) { container.innerHTML = `<div class="alert alert-error">${d.error}</div>`; return; }

            let results = d.results || [];

            // Filter out "Code Card" results for sealed ‚Äî those are almost never what stores want
            if (currentMapProductType !== 'raw') {
                const filtered = results.filter(p => {
                    const name = (p.name || p.productName || '').toLowerCase();
                    return !name.startsWith('code card');
                });
                if (filtered.length > 0) results = filtered;
            }

            if (!results.length) {
                container.innerHTML = `<p style="color:var(--text-dim);">No results found. Try pasting the TCGPlayer ID manually from tcgplayer.com.</p>`;
                return;
            }
            container.innerHTML = results.map(p => {
                const tcgId = p.tcgPlayerId || p.tcgplayer_id || '';
                const price = p.unopenedPrice || p.prices?.market || p.market_price || p.price || '';
                const name = p.name || p.productName || '?';
                const pSetName = p.setName || p.set || '';
                return `<div class="search-result" onclick="document.getElementById('map-tcgplayer-id').value='${tcgId}'">
                    <h4>${name}</h4>
                    <p>${pSetName} ${price ? '‚Ä¢ $' + price : ''}</p>
                    <small style="color:var(--accent);">TCGPlayer ID: ${tcgId} ‚Äî click to use</small>
                </div>`;
            }).join('');
        } catch(err) {
            container.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT OFFER % ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function editOfferPct(sessionId, currentPct) {
        const newPct = await themedPrompt({
            title: 'Edit Offer Percentage',
            message: `Current offer: ${currentPct}%`,
            inputs: [{ type: 'number', label: 'New offer percentage', default: String(currentPct), min: 1, max: 100, step: '0.5' }],
            confirmText: 'Update',
        });
        if (newPct === null || newPct === '') return;
        const val = parseFloat(newPct);
        if (isNaN(val) || val <= 0 || val > 100) { alert('Enter a valid percentage (1-100)'); return; }

        try {
            const r = await fetch(`/api/intake/session/${sessionId}/offer-percentage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ offer_percentage: val }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            // Reload session view to show updated prices
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REFRESH PRICES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function refreshPrices(sessionId) {
        const panel = document.getElementById('price-refresh-results');
        if (!panel) return;
        panel.innerHTML = '<div class="loading"><span class="spinner"></span> Fetching live PPT prices for all linked items...</div>';

        try {
            const r = await fetch(`/api/intake/session/${sessionId}/refresh-prices`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { panel.innerHTML = `<div class="alert alert-error">${d.error}</div>`; return; }

            const comps = d.comparisons || [];
            if (!comps.length) {
                panel.innerHTML = '<div class="alert alert-warning">No linked items to refresh.</div>';
                return;
            }

            const sigCount = comps.filter(c => c.significant).length;
            panel.innerHTML = `
                ${sigCount > 0 ? `<div class="alert alert-warning">‚ö† ${sigCount} item(s) have >10% price difference</div>` : 
                                  `<div class="alert alert-success">All prices are within 10% of PPT</div>`}
                <div style="overflow-x:auto; margin-bottom:16px;">
                <table>
                    <thead><tr>
                        <th>Product</th>
                        <th>Collectr</th>
                        <th>PPT Market</th>
                        <th>PPT Low</th>
                        <th>Delta</th>
                        <th></th>
                    </tr></thead>
                    <tbody>${comps.map(c => {
                        const delta = c.delta_pct;
                        const sig = c.significant;
                        const deltaColor = sig ? (delta > 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-dim)';
                        const arrow = delta > 0 ? '‚ñ≤' : delta < 0 ? '‚ñº' : '‚Äî';
                        return `<tr style="${sig ? 'background:rgba(255,180,0,0.06);' : ''}">
                            <td>${c.product_name}<br><small style="color:var(--text-dim);">ID: ${c.tcgplayer_id}</small></td>
                            <td>$${c.collectr_price.toFixed(2)}</td>
                            <td>${c.ppt_market != null ? '$' + c.ppt_market.toFixed(2) : '‚Äî'}</td>
                            <td>${c.ppt_low != null ? '$' + c.ppt_low.toFixed(2) : '‚Äî'}</td>
                            <td style="color:${deltaColor}; font-weight:${sig ? '700' : '400'};">
                                ${delta != null ? arrow + ' ' + Math.abs(delta).toFixed(1) + '%' : '‚Äî'}
                                ${sig ? ' ‚ö†' : ''}
                            </td>
                            <td>${c.ppt_market != null && sig ? `
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="applyPptPrice('${c.item_id}', '${sessionId}', ${c.ppt_market}, this)">
                                    Use PPT
                                </button>` : ''}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table>
                </div>
            `;
        } catch(err) {
            panel.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    async function applyPptPrice(itemId, sessionId, pptPrice, btn) {
        try {
            const r = await fetch('/api/intake/update-item-price', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_id: itemId, session_id: sessionId, new_price: pptPrice }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }

            // Update the row in-place
            const row = btn.closest('tr');
            if (row) {
                // Update Collectr column to show the new accepted price
                const cells = row.querySelectorAll('td');
                cells[1].innerHTML = `<span style="color:var(--green); font-weight:700;">$${pptPrice.toFixed(2)}</span>`;
                cells[4].innerHTML = `<span style="color:var(--green);">‚úì Updated</span>`;
                cells[5].innerHTML = '<span class="badge badge-green">Applied</span>';
                row.style.background = 'rgba(0,200,100,0.06)';
            }

            // Also update the session stats (market value / offer total) without reloading
            try {
                const sr = await fetch(`/api/intake/session/${sessionId}`);
                const sd = await sr.json();
                const s = sd.session;
                // Update the stats at the top
                const offerDisplay = document.getElementById('offer-pct-display');
                if (offerDisplay) {
                    // Find the stats container and update totals
                    const stats = offerDisplay.closest('.stats');
                    if (stats) {
                        const statValues = stats.querySelectorAll('.stat-value');
                        // Market Value stat (index 2)
                        if (statValues[2]) statValues[2].textContent = `$${(s.total_market_value || 0).toFixed(2)}`;
                        // Offer Total stat (index 4)
                        if (statValues[4]) statValues[4].textContent = `$${(s.total_offer_amount || 0).toFixed(2)}`;
                    }
                }
                // Also update the items table
                const itemRows = document.querySelectorAll('#session-modal-body table:last-of-type tbody tr');
                const items = sd.items;
                itemRows.forEach((tr, idx) => {
                    if (items[idx]) {
                        const tds = tr.querySelectorAll('td');
                        tds[2].textContent = `$${(items[idx].market_price || 0).toFixed(2)}`;
                        tds[3].textContent = `$${(items[idx].offer_price || 0).toFixed(2)}`;
                    }
                });
            } catch(e) { /* stats refresh failed, not critical */ }

        } catch(err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ITEM STATUS MANAGEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Close action dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.action-dropdown') && !e.target.closest('.action-trigger')) {
            document.querySelectorAll('.action-dropdown.show').forEach(d => d.classList.remove('show'));
        }
    });

    function toggleActionMenu(btn) {
        // Close all others first
        document.querySelectorAll('.action-dropdown.show').forEach(d => d.classList.remove('show'));
        const dd = btn.nextElementSibling;
        const rect = btn.getBoundingClientRect();
        // Position fixed, below the button, aligned right
        dd.style.top = (rect.bottom + 4) + 'px';
        dd.style.left = Math.max(8, rect.right - 160) + 'px'; // 160 = dropdown width
        dd.classList.toggle('show');
    }

    async function cancelSession(sessionId) {
        const reason = await themedPrompt({
            title: '‚úï Cancel Session',
            message: 'This session will be cancelled. No inventory will be created.',
            inputs: [{ type: 'text', label: 'Reason (optional)', placeholder: 'e.g. Deal fell through' }],
            confirmText: 'Cancel Session',
            dangerous: true,
        });
        if (reason === null) return;
        try {
            const r = await fetch(`/api/intake/cancel-session/${sessionId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason: reason || 'No reason given' }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function damageItem(itemId, sessionId, currentQty) {
        let damagedQty = 1;
        if (currentQty > 1) {
            const input = await themedPrompt({
                title: 'üî® Mark as Damaged',
                message: `This item has ${currentQty} units. How many are damaged? Damaged items receive 85% of the original offer.`,
                inputs: [{ type: 'number', label: 'Damaged quantity', default: '1', min: 1, max: currentQty }],
                confirmText: 'Split & Mark Damaged',
                dangerous: true,
            });
            if (input === null) return;
            damagedQty = parseInt(input);
            if (isNaN(damagedQty) || damagedQty < 1 || damagedQty > currentQty) {
                alert(`Must be between 1 and ${currentQty}`);
                return;
            }
        } else {
            const ok = await themedConfirm(
                'üî® Mark as Damaged',
                'Mark this item as damaged? Offer becomes 85% of original.',
                { confirmText: 'Mark Damaged', dangerous: true }
            );
            if (!ok) return;
        }
        try {
            const r = await fetch(`/api/intake/item/${itemId}/damage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ damaged_qty: damagedQty }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function markMissing(itemId, sessionId) {
        const ok = await themedConfirm(
            '‚ùå Mark as Missing',
            'This item will be excluded from payment and Shopify push.',
            { confirmText: 'Mark Missing', dangerous: true }
        );
        if (!ok) return;
        try {
            const r = await fetch(`/api/intake/item/${itemId}/missing`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function markRejected(itemId, sessionId) {
        const ok = await themedConfirm(
            'üö´ Mark as Rejected',
            'Seller kept this item. It will be excluded from payment.',
            { confirmText: 'Mark Rejected', dangerous: true }
        );
        if (!ok) return;
        try {
            const r = await fetch(`/api/intake/item/${itemId}/rejected`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function restoreItem(itemId, sessionId) {
        const ok = await themedConfirm(
            'Restore Item',
            'Restore this item back to good status?',
            { confirmText: 'Restore' }
        );
        if (!ok) return;
        try {
            const r = await fetch(`/api/intake/item/${itemId}/restore`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function overridePrice(itemId, sessionId, currentPrice) {
        const values = await themedPrompt({
            title: 'üí∞ Override Price',
            message: `Current market price: $${currentPrice.toFixed(2)}`,
            inputs: [
                { type: 'number', label: 'New market price', default: currentPrice.toFixed(2), min: 0, step: '0.01' },
                { type: 'text', label: 'Reason', placeholder: 'e.g. Better packs version, EV $45+' },
            ],
            confirmText: 'Override Price',
        });
        if (values === null) return;
        const [priceStr, note] = values;
        const parsed = parseFloat(priceStr);
        if (isNaN(parsed) || parsed < 0) { alert('Invalid price'); return; }

        try {
            const r = await fetch(`/api/intake/item/${itemId}/override-price`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ new_price: parsed, note: note, session_id: sessionId }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function editQuantity(itemId, sessionId, currentQty) {
        const input = await themedPrompt({
            title: '‚úè Edit Quantity',
            message: `Current quantity: ${currentQty}`,
            inputs: [{ type: 'number', label: 'New quantity', default: String(currentQty), min: 1 }],
            confirmText: 'Update Quantity',
        });
        if (input === null) return;
        const newQty = parseInt(input);
        if (isNaN(newQty) || newQty < 1) { alert('Invalid quantity'); return; }
        if (newQty === currentQty) return;

        try {
            const r = await fetch(`/api/intake/item/${itemId}/update-quantity`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ quantity: newQty, session_id: sessionId }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    async function deleteItem(itemId, sessionId) {
        const ok = await themedConfirm(
            'üóë Delete Item',
            'Permanently remove this item from the session? This cannot be undone.',
            { confirmText: 'Delete', dangerous: true }
        );
        if (!ok) return;
        try {
            const r = await fetch(`/api/intake/item/${itemId}/delete`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            viewSession(sessionId);
        } catch(err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD SEALED ITEM TO EXISTING SESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function searchSealedForSession(sessionId, offerPct) {
        const searchTerm = document.getElementById('session-sealed-search').value.trim();
        const resultsDiv = document.getElementById('session-sealed-results');
        if (!searchTerm) { resultsDiv.innerHTML = '<div class="alert alert-warning">Enter a search term</div>'; return; }

        resultsDiv.innerHTML = '<div class="loading"><span class="spinner"></span> Searching PPT...</div>';
        try {
            const r = await fetch('/api/ppt/search-sealed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: searchTerm }),
            });
            const d = await r.json();
            if (!r.ok) { resultsDiv.innerHTML = `<div class="alert alert-error">${d.error}</div>`; return; }

            const products = d.results || [];
            if (!products.length) { resultsDiv.innerHTML = '<div class="alert alert-warning">No results found</div>'; return; }

            const qty = parseInt(document.getElementById('session-sealed-qty').value) || 1;
            resultsDiv.innerHTML = products.map(p => {
                const price = p.unopenedPrice || p.prices?.market || 0;
                const offer = (price * qty * offerPct / 100).toFixed(2);
                return `<div class="search-result" onclick="addSealedToSession('${sessionId}', ${p.tcgPlayerId || p.tcgplayer_id}, '${(p.name||'').replace(/'/g,"\\'")}', ${price}, ${qty}, ${offerPct})">
                    <h4>${p.name}</h4>
                    <p>TCG#${p.tcgPlayerId || p.tcgplayer_id} ¬∑ $${price.toFixed(2)} each ¬∑ Qty ${qty} ¬∑ Offer: $${offer}</p>
                </div>`;
            }).join('');
        } catch(err) {
            resultsDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    async function addSealedToSession(sessionId, tcgplayerId, name, price, qty, offerPct) {
        const resultsDiv = document.getElementById('session-sealed-results');
        resultsDiv.innerHTML = '<div class="loading"><span class="spinner"></span> Adding...</div>';
        try {
            // Add the item via the existing import-like endpoint
            const offerPrice = price * qty * (offerPct / 100);
            const r = await fetch('/api/intake/add-sealed-item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId,
                    product_name: name,
                    tcgplayer_id: tcgplayerId,
                    market_price: price,
                    quantity: qty,
                }),
            });
            const d = await r.json();
            if (!r.ok) { resultsDiv.innerHTML = `<div class="alert alert-error">${d.error}</div>`; return; }

            // Clear and reload
            document.getElementById('session-sealed-search').value = '';
            document.getElementById('session-sealed-qty').value = '1';
            resultsDiv.innerHTML = '<div class="alert alert-success">Added! ‚úì</div>';
            setTimeout(() => viewSession(sessionId), 500);
        } catch(err) {
            resultsDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD CARD TO EXISTING SESSION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function addCardToExistingSession(sessionId, offerPct) {
        const tcgId = document.getElementById('session-raw-tcg-id').value;
        const condition = document.getElementById('session-raw-condition').value;
        const variant = document.getElementById('session-raw-variant').value;
        const quantity = parseInt(document.getElementById('session-raw-qty').value) || 1;
        const resultDiv = document.getElementById('session-raw-result');

        if (!tcgId) { alert('Enter a TCGPlayer ID'); return; }

        resultDiv.innerHTML = '<div class="loading"><span class="spinner"></span> Looking up card...</div>';

        // Step 1: Look up card via PPT
        try {
            const lr = await fetch('/api/ppt/lookup-card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tcgplayer_id: parseInt(tcgId) }),
            });
            const ld = await lr.json();
            if (!lr.ok) {
                resultDiv.innerHTML = `<div class="alert alert-error">${ld.error || 'Card not found'}</div>`;
                return;
            }

            const card = ld.card || {};
            const variants = ld.variants || {};
            const primaryPrinting = ld.primary_printing || '';

            // Get price for selected variant + condition
            const useVariant = variant || primaryPrinting;
            let price = null;
            if (variants[useVariant] && variants[useVariant][condition] != null) {
                price = variants[useVariant][condition];
            } else if (card.prices?.market) {
                price = card.prices.market;
            }

            if (!price) {
                resultDiv.innerHTML = `<div class="alert alert-warning">Found "${card.name}" but no price for ${useVariant} / ${condition}. Enter price manually below.
                    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                        <input type="number" id="session-raw-manual-price" placeholder="Price" step="0.01" style="width:120px;">
                        <button class="btn btn-primary btn-sm" onclick="submitCardToSession('${sessionId}', ${parseInt(tcgId)}, '${(card.name||'').replace(/'/g,"\\'")}', '${condition}', '${card.set?.name || ''}', '${card.number || ''}', '${card.rarity || ''}', ${quantity}, parseFloat(document.getElementById('session-raw-manual-price').value))">Add</button>
                    </div>
                </div>`;
                return;
            }

            // Step 2: Show confirmation and add
            resultDiv.innerHTML = `
                <div style="background:var(--surface-2); border-radius:8px; padding:12px; margin-top:8px;">
                    <strong style="color:var(--accent);">${card.name}</strong>
                    ${card.set?.name ? `<span style="color:var(--text-dim);"> ‚Äî ${card.set.name}</span>` : ''}
                    <br>
                    <span>${useVariant} / ${condition} ‚Äî <strong>$${price.toFixed(2)}</strong></span>
                    <span style="margin-left:8px; color:var(--text-dim);">√ó ${quantity}</span>
                    <button class="btn btn-primary btn-sm" style="margin-left:12px;"
                            onclick="submitCardToSession('${sessionId}', ${parseInt(tcgId)}, '${(card.name||'').replace(/'/g,"\\'")}', '${condition}', '${card.set?.name || ''}', '${card.number || ''}', '${card.rarity || ''}', ${quantity}, ${price})">
                        Confirm &amp; Add
                    </button>
                </div>
            `;
        } catch(err) {
            resultDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        }
    }

    async function submitCardToSession(sessionId, tcgId, cardName, condition, setName, cardNum, rarity, qty, price) {
        try {
            const r = await fetch('/api/intake/add-raw-card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId,
                    tcgplayer_id: tcgId,
                    card_name: cardName,
                    condition: condition,
                    set_name: setName,
                    card_number: cardNum,
                    rarity: rarity,
                    quantity: qty,
                    market_price: price,
                }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }

            // Clear inputs and reload session
            document.getElementById('session-raw-tcg-id').value = '';
            document.getElementById('session-raw-variant').value = '';
            document.getElementById('session-raw-qty').value = '1';
            document.getElementById('session-raw-result').innerHTML = 
                '<div class="alert alert-success">Card added! ‚úì</div>';

            // Reload session view to show updated table
            setTimeout(() => viewSession(sessionId), 500);
        } catch(err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FINALIZE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function finalizeSession(sessionId) {
        const ok = await themedConfirm(
            'Finalize Session',
            'This will lock all prices and create inventory/COGS records. This cannot be undone.',
            { confirmText: 'Finalize' }
        );
        if (!ok) return;
        try {
            const r = await fetch(`/api/intake/finalize/${sessionId}`, { method: 'POST' });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            alert(`Finalized! ${d.sealed_processed || 0} sealed COGS updated, ${d.raw_cards_created || 0} raw cards created.`);
            closeModal('session-modal');
        } catch(err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RAW CARD MANUAL ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function createRawSession() {
        const customer = document.getElementById('raw-customer').value || 'Walk-in';
        const offerPct = document.getElementById('raw-offer-pct').value || '65';
        try {
            const r = await fetch('/api/intake/create-session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ customer_name: customer, session_type: 'raw', offer_percentage: parseFloat(offerPct) }),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }
            rawSessionId = d.session.id;
            document.getElementById('raw-session-setup').style.display = 'none';
            document.getElementById('raw-entry-form').style.display = 'block';
            document.getElementById('raw-session-info').innerHTML =
                `Session started for <strong>${customer}</strong> ‚Ä¢ Offer: ${offerPct}% ‚Ä¢ ID: ${rawSessionId.slice(0,8)}...`;
        } catch(err) { alert(err.message); }
    }

    let lastCardLookup = null;

    async function lookupRawCard() {
        const tcgId = document.getElementById('raw-tcgplayer-id').value;
        if (!tcgId) { alert('Enter a TCGPlayer ID first'); return; }

        const resultDiv = document.getElementById('raw-lookup-result');
        resultDiv.innerHTML = '<div class="loading"><span class="spinner"></span> Looking up...</div>';

        try {
            const r = await fetch('/api/ppt/lookup-card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tcgplayer_id: parseInt(tcgId) }),
            });
            const d = await r.json();
            if (!r.ok) { resultDiv.innerHTML = `<div class="alert alert-warning">${d.error}</div>`; lastCardLookup = null; return; }

            const c = d.card;
            lastCardLookup = { card: c, variants: d.variants || {}, primary: d.primary_printing || 'Default' };

            // Auto-fill fields
            if (c.name) document.getElementById('raw-card-name').value = c.name;
            if (c.setName) document.getElementById('raw-set-name').value = c.setName;
            if (c.cardNumber) document.getElementById('raw-card-number').value = c.cardNumber;
            if (c.rarity) document.getElementById('raw-rarity').value = c.rarity;

            renderVariantPrices();
        } catch(err) {
            resultDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            lastCardLookup = null;
        }
    }

    let selectedVariant = null;

    function renderVariantPrices() {
        if (!lastCardLookup) return;
        const resultDiv = document.getElementById('raw-lookup-result');
        const c = lastCardLookup.card;
        const variants = lastCardLookup.variants;
        const variantNames = Object.keys(variants);
        const selectedCond = document.getElementById('raw-condition').value;

        // Auto-select variant
        if (!selectedVariant || !variants[selectedVariant]) {
            selectedVariant = lastCardLookup.primary;
            if (!variants[selectedVariant] && variantNames.length) selectedVariant = variantNames[0];
        }

        const currentVariant = variants[selectedVariant] || {};

        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <strong>${c.name}</strong> ‚Äî ${c.setName || ''} #${c.cardNumber || ''}
            </div>

            ${variantNames.length > 1 ? `
            <div style="margin-bottom:10px;">
                <label style="font-size:0.8rem; color:var(--text-dim); margin-bottom:4px; display:block;">Variant / Printing</label>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    ${variantNames.map(v => `
                        <button class="btn btn-sm ${v === selectedVariant ? 'btn-primary' : 'btn-secondary'}"
                                onclick="selectedVariant='${v.replace(/'/g,"\\'")}'; renderVariantPrices();">
                            ${v}
                        </button>
                    `).join('')}
                </div>
            </div>` : (variantNames.length === 1 ? `
            <div style="margin-bottom:8px; font-size:0.85rem; color:var(--text-dim);">
                Printing: <strong style="color:var(--text);">${variantNames[0]}</strong>
            </div>` : '')}

            <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px;">
                ${['NM','LP','MP','HP','DMG'].map(cond => {
                    const price = currentVariant[cond];
                    const isSelected = cond === selectedCond;
                    const hasPrice = price !== null && price !== undefined;
                    return `
                    <div style="background:var(${isSelected ? '--accent' : '--surface-2'});
                                color:${isSelected ? '#fff' : 'var(--text)'};
                                padding:10px 6px; border-radius:6px; text-align:center; cursor:pointer;
                                border:1px solid var(--border); opacity:${hasPrice ? '1' : '0.4'};"
                         onclick="document.getElementById('raw-condition').value='${cond}'; renderVariantPrices();">
                        <div style="font-size:0.75rem; font-weight:600;">${cond}</div>
                        <div style="font-size:1.05rem; font-weight:700;">${hasPrice ? '$'+price.toFixed(2) : '‚Äî'}</div>
                    </div>`;
                }).join('')}
            </div>
            <small style="color:var(--text-dim); margin-top:6px; display:block;">
                ${selectedVariant !== 'Default' ? `<strong>${selectedVariant}</strong> ‚Ä¢ ` : ''}
                Selected: <strong>${selectedCond}</strong>
                ‚Üí ${currentVariant[selectedCond] != null ? '$' + currentVariant[selectedCond].toFixed(2) : 'no price data (will use market price)'}
            </small>
        `;
    }

    // Re-render when condition dropdown changes
    document.getElementById('raw-condition').addEventListener('change', renderVariantPrices);

    async function addRawCard() {
        if (!rawSessionId) { alert('Start a session first'); return; }
        const tcgId = document.getElementById('raw-tcgplayer-id').value;
        const cardName = document.getElementById('raw-card-name').value;
        const condition = document.getElementById('raw-condition').value;
        const quantity = document.getElementById('raw-quantity').value || '1';

        if (!tcgId || !cardName || !condition) { alert('TCGPlayer ID, Card Name, and Condition are required'); return; }

        const body = {
            session_id: rawSessionId,
            tcgplayer_id: parseInt(tcgId),
            card_name: cardName,
            condition: condition,
            quantity: parseInt(quantity),
            set_name: document.getElementById('raw-set-name').value,
            card_number: document.getElementById('raw-card-number').value,
            rarity: document.getElementById('raw-rarity').value,
        };
        const priceOverride = document.getElementById('raw-price-override').value;
        if (priceOverride) body.market_price = parseFloat(priceOverride);

        try {
            const r = await fetch('/api/intake/add-raw-card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const d = await r.json();
            if (!r.ok) { alert(d.error); return; }

            // Clear form (except session fields)
            document.getElementById('raw-tcgplayer-id').value = '';
            document.getElementById('raw-card-name').value = '';
            document.getElementById('raw-card-number').value = '';
            document.getElementById('raw-set-name').value = '';
            document.getElementById('raw-rarity').value = '';
            document.getElementById('raw-price-override').value = '';
            document.getElementById('raw-quantity').value = '1';
            document.getElementById('raw-lookup-result').innerHTML = '';

            // Reload items table
            loadRawSessionItems();
        } catch(err) { alert(err.message); }
    }

    async function loadRawSessionItems() {
        if (!rawSessionId) return;
        try {
            const r = await fetch(`/api/intake/session/${rawSessionId}`);
            const d = await r.json();
            const items = d.items;
            const s = d.session;

            const tableDiv = document.getElementById('raw-items-table');
            if (!items.length) { tableDiv.innerHTML = '<p style="color:var(--text-dim);">No cards added yet.</p>'; return; }

            tableDiv.innerHTML = `
                <div style="margin-top:16px; margin-bottom:8px; font-weight:600;">
                    ${items.length} cards ‚Ä¢ Total offer: $${(s.total_offer_amount || 0).toFixed(2)}
                </div>
                <table>
                    <thead><tr><th>Card</th><th>Condition</th><th>Qty</th><th>Market</th><th>Offer</th></tr></thead>
                    <tbody>${items.map(i => `<tr>
                        <td>${i.product_name}<br><small style="color:var(--text-dim);">${i.set_name || ''}</small></td>
                        <td><span class="badge badge-blue">${i.condition || ''}</span></td>
                        <td>${i.quantity}</td>
                        <td>$${(i.market_price || 0).toFixed(2)}</td>
                        <td>$${(i.offer_price || 0).toFixed(2)}</td>
                    </tr>`).join('')}</tbody>
                </table>`;
        } catch(err) { console.error(err); }
    }

    async function finalizeRawSession() {
        if (!rawSessionId) return;
        await finalizeSession(rawSessionId);
        // Reset the raw entry form
        rawSessionId = null;
        document.getElementById('raw-session-setup').style.display = 'block';
        document.getElementById('raw-entry-form').style.display = 'none';
        document.getElementById('raw-items-table').innerHTML = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEALTH CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkHealth() {
        try {
            const r = await fetch('/health');
            const d = await r.json();
            const dot = document.getElementById('health-dot');
            const txt = document.getElementById('health-text');
            if (d.status === 'healthy') {
                dot.className = 'status-dot ok';
                txt.textContent = `DB ‚úì ‚Ä¢ PPT ${d.ppt === 'configured' ? '‚úì' : '‚úó'}`;
            } else {
                dot.className = 'status-dot warn';
                txt.textContent = 'Unhealthy';
            }
        } catch { /* silent */ }
    }
    checkHealth();
    setInterval(checkHealth, 30000);
    </script>
</body>
</html>
